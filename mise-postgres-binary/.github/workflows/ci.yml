name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: jdx/mise-action@v2
        with:
          experimental: true
      - name: Run linters
        run: mise run lint

  test:
    name: Test (${{ matrix.os }}, PG ${{ matrix.pg_version }})
    needs: lint
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, ubuntu-22.04, macos-latest, macos-13]
        pg_version: ["15.15.0", "16.11.0", "17.7.0"]
        exclude:
          # Reduce matrix size - test all PG versions on latest OS only
          - os: ubuntu-22.04
            pg_version: "16.11.0"
          - os: ubuntu-22.04
            pg_version: "17.7.0"
          - os: macos-13
            pg_version: "16.11.0"
          - os: macos-13
            pg_version: "17.7.0"
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: jdx/mise-action@v2
        with:
          experimental: true

      - name: Link plugin
        run: mise plugin link --force postgres-binary "$PWD"

      - name: List available versions
        run: mise ls-remote postgres-binary:postgres | head -10

      - name: Install PostgreSQL ${{ matrix.pg_version }}
        run: mise install postgres-binary:postgres@${{ matrix.pg_version }}

      - name: Verify binaries
        run: |
          mise exec postgres-binary:postgres@${{ matrix.pg_version }} -- postgres --version
          mise exec postgres-binary:postgres@${{ matrix.pg_version }} -- psql --version
          mise exec postgres-binary:postgres@${{ matrix.pg_version }} -- pg_dump --version
          mise exec postgres-binary:postgres@${{ matrix.pg_version }} -- pg_restore --version
          mise exec postgres-binary:postgres@${{ matrix.pg_version }} -- initdb --version

      - name: Check environment setup
        run: |
          eval "$(mise activate bash)"
          mise use postgres-binary:postgres@${{ matrix.pg_version }}
          echo "PGDATA=$PGDATA"
          echo "PGHOME=$PGHOME"
          [ -d "$PGDATA" ] && echo "PGDATA directory exists" || exit 1
          [ -f "$PGDATA/PG_VERSION" ] && echo "Database initialized" || exit 1

      - name: Start PostgreSQL and run query
        run: |
          eval "$(mise activate bash)"
          mise use postgres-binary:postgres@${{ matrix.pg_version }}
          pg_ctl start -D "$PGDATA" -l /tmp/pg.log -w
          psql -c "SELECT version();" postgres
          psql -c "CREATE TABLE test_table (id SERIAL PRIMARY KEY, name TEXT);" postgres
          psql -c "INSERT INTO test_table (name) VALUES ('mise-postgres-binary');" postgres
          psql -c "SELECT * FROM test_table;" postgres
          pg_ctl stop -D "$PGDATA" -m fast

  test-docker:
    name: Test Docker (${{ matrix.distro }})
    needs: lint
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        distro: [debian, alpine]
    steps:
      - uses: actions/checkout@v4

      - name: Build and test ${{ matrix.distro }}
        run: |
          docker build -f test/Dockerfile.${{ matrix.distro }} -t mise-postgres-${{ matrix.distro }} .
          docker run --rm mise-postgres-${{ matrix.distro }}

  # Windows is experimental - theseus-rs provides Windows binaries
  test-windows:
    name: Test (Windows)
    needs: lint
    runs-on: windows-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: jdx/mise-action@v2
        with:
          experimental: true

      - name: Link plugin
        shell: bash
        run: mise plugin link --force postgres-binary "$PWD"

      - name: List available versions
        shell: bash
        run: mise ls-remote postgres-binary:postgres | head -10

      - name: Install PostgreSQL
        shell: bash
        run: mise install postgres-binary:postgres@15.15.0

      - name: Verify binaries
        shell: bash
        run: |
          mise exec postgres-binary:postgres@15.15.0 -- postgres --version
          mise exec postgres-binary:postgres@15.15.0 -- psql --version
